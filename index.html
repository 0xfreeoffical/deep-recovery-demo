<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Deep Recovery Pad</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;color:#fff;-webkit-tap-highlight-color:transparent}
canvas{position:fixed;top:0;left:0;z-index:0}
#ui{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;display:flex;flex-direction:column}
#top{display:flex;justify-content:space-between;align-items:flex-start;padding:28px 24px 0}
#title{font-size:15px;font-weight:700;letter-spacing:3px;text-transform:uppercase}
#dose{font-family:'SF Mono',SFMono-Regular,Menlo,monospace;font-size:12px;letter-spacing:2px;opacity:.7;text-align:right}
#dose .label{font-size:10px;display:block;margin-bottom:2px;letter-spacing:3px}
#center{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center}
#state-word{font-size:clamp(28px,7vw,52px);font-weight:200;letter-spacing:8px;text-transform:uppercase;opacity:.85;margin-bottom:40px;transition:opacity .6s}
#buttons{display:flex;gap:16px;margin-top:40px;pointer-events:auto}
#buttons button{background:transparent;border:1px solid rgba(255,255,255,.3);color:#fff;padding:12px 32px;font-size:13px;letter-spacing:3px;text-transform:uppercase;cursor:pointer;border-radius:40px;font-family:inherit;transition:all .3s}
#buttons button:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.6)}
#buttons button:active{transform:scale(.96)}
.hidden{display:none!important}
</style>
</head>
<body>
<div id="ui">
  <div id="top">
    <div id="title">Deep Recovery</div>
    <div id="dose"><span class="label">DOSE</span><span id="dose-val">01 / 30</span></div>
  </div>
  <div id="center">
    <div id="state-word">Entropy</div>
    <div id="buttons">
      <button id="btn-init" onclick="startHarmonize()">Initialize Field</button>
      <button id="btn-reset" class="hidden" onclick="resetField()">Reset</button>
      <button id="btn-replenish" class="hidden" onclick="resetField()">Replenish Pad</button>
    </div>
  </div>
</div>
<script>
// --- THREE.JS SETUP ---
const W=window.innerWidth, H=window.innerHeight;
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setSize(W,H);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
document.body.appendChild(renderer.domElement);
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(45,W/H,.1,100);
camera.position.z=5;

// --- PARTICLE SPHERE ---
const N=900;
const basePositions=new Float32Array(N*3);
const offsets=new Float32Array(N*3);
const sizes=new Float32Array(N);
const glowSizes=new Float32Array(N);

// Fibonacci sphere distribution
for(let i=0;i<N;i++){
  const y=1-(i/(N-1))*2;
  const r=Math.sqrt(1-y*y);
  const phi=i*2.399963; // golden angle
  basePositions[i*3]=Math.cos(phi)*r;
  basePositions[i*3+1]=y;
  basePositions[i*3+2]=Math.sin(phi)*r;
  offsets[i*3]=(Math.random()-.5)*.06;
  offsets[i*3+1]=(Math.random()-.5)*.06;
  offsets[i*3+2]=(Math.random()-.5)*.06;
  sizes[i]=Math.random()*.5+.5;
  glowSizes[i]=Math.random()*.4+.8;
}

function makeParticleSystem(sizeArr,opacity,baseSize){
  const geo=new THREE.BufferGeometry();
  const pos=new Float32Array(N*3);
  for(let i=0;i<N*3;i++) pos[i]=basePositions[i]+offsets[i];
  geo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const colors=new Float32Array(N*3);
  geo.setAttribute('color',new THREE.BufferAttribute(colors,3));
  const mat=new THREE.PointsMaterial({
    size:baseSize,
    vertexColors:true,
    transparent:true,
    opacity:opacity,
    blending:THREE.AdditiveBlending,
    depthWrite:false,
    sizeAttenuation:true
  });
  const pts=new THREE.Points(geo,mat);
  return pts;
}

const sphere=makeParticleSystem(sizes,.95,.055);
const glow=makeParticleSystem(glowSizes,.25,.16);
const group=new THREE.Group();
group.add(sphere);group.add(glow);
scene.add(group);

// --- STATE ---
let state='standby'; // standby | harmonizing | restored
let progress=0; // 0-1
let audioCtx=null, oscillators=[];

// --- COLOR ---
const cEntropy=new THREE.Color(.95,.25,.1);
const cMid=new THREE.Color(.55,.2,.85);
const cRestored=new THREE.Color(.4,.7,1);
const cWhite=new THREE.Color(.85,.92,1);
const tmpColor=new THREE.Color();

function updateColors(p){
  const cols=sphere.geometry.attributes.color.array;
  const gcols=glow.geometry.attributes.color.array;
  for(let i=0;i<N;i++){
    if(p<.5) tmpColor.copy(cEntropy).lerp(cMid,p*2);
    else tmpColor.copy(cMid).lerp(cRestored,(p-.5)*2);
    if(p>.85) tmpColor.lerp(cWhite,(p-.85)/.15*.3);
    const v=.9+Math.random()*.1;
    const idx=i*3;
    cols[idx]=tmpColor.r*v;cols[idx+1]=tmpColor.g*v;cols[idx+2]=tmpColor.b*v;
    gcols[idx]=tmpColor.r;gcols[idx+1]=tmpColor.g;gcols[idx+2]=tmpColor.b;
  }
  sphere.geometry.attributes.color.needsUpdate=true;
  glow.geometry.attributes.color.needsUpdate=true;
}

// --- JITTER ---
function updateJitter(t){
  const pos=sphere.geometry.attributes.position.array;
  const gpos=glow.geometry.attributes.position.array;
  const jitterAmt=state==='harmonizing'? .03*(1-progress)+.005 : state==='restored'? .005 : .04;
  for(let i=0;i<N;i++){
    const idx=i*3;
    const bx=basePositions[idx],by=basePositions[idx+1],bz=basePositions[idx+2];
    const ox=Math.sin(t*1.1+i*3.7)*jitterAmt;
    const oy=Math.cos(t*1.3+i*2.3)*jitterAmt;
    const oz=Math.sin(t*.9+i*5.1)*jitterAmt;
    pos[idx]=bx+ox;pos[idx+1]=by+oy;pos[idx+2]=bz+oz;
    gpos[idx]=bx+ox;gpos[idx+1]=by+oy;gpos[idx+2]=bz+oz;
  }
  sphere.geometry.attributes.position.needsUpdate=true;
  glow.geometry.attributes.position.needsUpdate=true;
}

// --- AUDIO ---
function startAudio(){
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  const freqs=[136.1,272.2,408.3];
  const gains=[.08,.04,.02];
  freqs.forEach((f,i)=>{
    const osc=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    osc.type='sine';osc.frequency.value=f;
    g.gain.value=0;
    g.gain.linearRampToValueAtTime(gains[i],audioCtx.currentTime+2);
    osc.connect(g);g.connect(audioCtx.destination);
    osc.start();
    oscillators.push({osc,gain:g});
  });
}
function stopAudio(){
  if(!audioCtx)return;
  const t=audioCtx.currentTime;
  oscillators.forEach(o=>{o.gain.gain.linearRampToValueAtTime(0,t+1.5);o.osc.stop(t+1.6)});
  setTimeout(()=>{audioCtx.close();audioCtx=null;oscillators=[]},2000);
}

// --- UI ---
const elState=document.getElementById('state-word');
const elDose=document.getElementById('dose-val');
const btnInit=document.getElementById('btn-init');
const btnReset=document.getElementById('btn-reset');
const btnReplenish=document.getElementById('btn-replenish');

function setDose(n){elDose.textContent=String(n).padStart(2,'0')+' / 30'}

// --- HARMONIZE ---
let harmStart=0;
const DURATION=20;

function startHarmonize(){
  if(state!=='standby')return;
  state='harmonizing';
  harmStart=performance.now()/1000;
  elState.textContent='Harmonizing';
  btnInit.classList.add('hidden');
  startAudio();
  // breathing
  gsap.to(group.scale,{x:1.06,y:1.06,z:1.06,duration:3,yoyo:true,repeat:-1,ease:'sine.inOut'});
}

function finishRestore(){
  state='restored';
  progress=1;
  setDose(30);
  elState.textContent='Restored';
  btnReset.classList.remove('hidden');
  btnReplenish.classList.remove('hidden');
  gsap.killTweensOf(group.scale);
  gsap.to(group.scale,{x:1,y:1,z:1,duration:2,ease:'sine.out'});
  // gentle pulse for restored
  setTimeout(()=>{
    if(state==='restored') gsap.to(group.scale,{x:1.03,y:1.03,z:1.03,duration:4,yoyo:true,repeat:-1,ease:'sine.inOut'});
  },2100);
  stopAudio();
}

function resetField(){
  state='standby';progress=0;
  gsap.killTweensOf(group.scale);
  gsap.to(group.scale,{x:1,y:1,z:1,duration:1});
  elState.textContent='Entropy';
  setDose(1);
  btnInit.classList.remove('hidden');
  btnReset.classList.add('hidden');
  btnReplenish.classList.add('hidden');
  updateColors(0);
}

// --- RENDER LOOP ---
function animate(){
  requestAnimationFrame(animate);
  const t=performance.now()/1000;
  group.rotation.y=t*.15;

  if(state==='harmonizing'){
    progress=Math.min((t-harmStart)/DURATION,1);
    const dose=Math.floor(progress*29)+1;
    setDose(dose);
    if(progress>=1) finishRestore();
  }

  updateColors(progress);
  updateJitter(t);

  // glow intensity
  glow.material.opacity=state==='restored'?.4: state==='harmonizing'? .2+progress*.2 : .2;

  renderer.render(scene,camera);
}
updateColors(0);
animate();

// --- RESIZE ---
window.addEventListener('resize',()=>{
  const w=window.innerWidth,h=window.innerHeight;
  camera.aspect=w/h;camera.updateProjectionMatrix();
  renderer.setSize(w,h);
});
</script>
</body>
</html>
